{
    "Title": "Clamor Voter Service",
    "Commands": {
        "_build": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "docker",
                            "run",
                            "--rm",
                            "-v",
                            "${DIR}/src:/go/src/clamor",
                            "-w",
                            "/go/src/clamor",
                            "lushdigital/docker-golang-dep",
                            "ensure"
                        ]
                    }
                },
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "docker",
                            "run",
                            "--rm",
                            "-v",
                            "${DIR}/src:/go/src/clamor",
                            "-w",
                            "/go/src/clamor",
                            "golang:latest",
                            "go",
                            "build",
                            "-ldflags",
                            "-linkmode external -extldflags -static",
                            "-o",
                            "voter"
                        ]
                    }
                }
            ]
        },

        "_pack": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "docker",
                            "build",
                            "-f",
                            "./Dockerfile",
                            "-t",
                            "${DOCKER_REG}/clamor/voter-service",
                            "."
                        ]
                    }
                }
            ]
        },

        "_upload": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "docker",
                            "push",
                            "${DOCKER_REG}/clamor/voter-service"
                        ]
                    }
                }
            ]
        },

        "build": {
            "Requires": ["_build", "_pack", "_upload"],
            "Steps": [
                {
                    "Type": "CopyFile",
                    "Args": {
                        "Source": "k8s/deployment.template.yaml",
                        "Target": "deployment.yaml"
                    }
                },
                {
                    "Type": "RunTemplate",
                    "Args": {
                        "File": "deployment.yaml"
                    }
                }
            ]
        },

        "deploy": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "EnsureSecret",
                    "Args": {
                        "Key": "clamor-voter-service-mysql-password"
                    }
                },
                {
                    "Type": "EnsureSecret",
                    "Args": {
                        "Key": "clamor-voter-service-mysql-root-password"
                    }
                },
                {
                    "Type": "DoublePipeCommand",
                    "Args": {
                        "Source": [
                            "cat",
                            "deployment.yaml"
                        ],
                        "Target1": [
                            "envsubst"
                        ],
                        "Target2": [
                            "kubectl",
                            "apply",
                            "-f",
                            "-"
                        ]
                    }
                }
            ]
        },

        "ensure": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "kubectl",
                            "create",
                            "job",
                            "--from=cronjob/voter-service-ensure-cronjob",
                            "voter-service-ensure-cronjob-job"
                        ]
                    }
                }
            ]
        },

        "export": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "docker",
                            "run",
                            "-it",
                            "-v",
                            "${DIR}/data:/data",
                            "-v",
                            "${DIR}/working:/working",
                            "${DOCKER_REG}/clamor/voter-service",
                            "/voter",
                            "export"
                        ]
                    }
                }
            ]
        },

        "stop": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "kubectl",
                            "delete",
                            "deployments,services,pods,pv,pvc,cronjob,job",
                            "--all"
                        ]
                    }
                }
            ]
        },

        "clean": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "rm",
                            "-rf",
                            "${DIR}/working/mysql"
                        ]
                    }
                }
            ]
        }
    }
}
